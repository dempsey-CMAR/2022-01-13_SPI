---
title: "Application of coastal temperature regimens to inform selection of year-round & seasonal sites for <br/> Atlantic salmon culture"
subtitle: ""
author: "Danielle Dempsey, Gregor Reid, et al."
institute: "CMAR"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
---
layout: true

background-image: url(logo2.png)
background-position: 50% 100%
background-size: 100%
---

```{r, echo=FALSE, message=FALSE, warning=FALSE}

knitr::opts_chunk$set(echo=FALSE, fig.width=15, fig.retina=3, message=FALSE)

library(dplyr)         # data manipulation 
library(DT)            # interactive tables
library(ggplot2)       # figures
library(glue)
library(here)
library(leaflet)       # interactive map   
library(lubridate)
library(plotly)        # interactive figures
library(readr)         # read in station locations
library(strings)       # convert_depth_to_ordered_factor() function
library(tgc)           # season functions
library(xaringanthemer) # converts R code to css style sheet

# slide formatting
font_style <- "Kumbh Sans"
# main_color <- "#2088e8"
main_color <- "#04a4e4"

# generates css style sheet (used to apply formatting to slides)
style_mono_accent(
  base_color = main_color,
  
  title_slide_text_color = main_color,
  title_slide_background_color = "white",
  
  header_font_google = google_font(font_style),
  text_font_google   = google_font(font_style, "300", "300i"),
  code_font_google   = google_font("Fira Mono"),
  header_h1_font_size = "2rem",
  text_font_size = "1.25rem",

  padding = "0px 64px 16px 64px"
)

# DT options
dt_options <- list(
      dom = 'ft',
      paging = FALSE,
      searching = TRUE,
      scrollY = "500px",
      scrollX = "500px",
      pageLength = 500,
      columnDefs = list(list(className = 'dt-center', targets = "_all"))
)

theme_set(theme_light())

```

```{r, echo=FALSE}

# # import data
# dat_raw <- import_strings_data(
#   add_county_col = FALSE,
#   county = c("Halifax", "Guysborough_Dover Bay", "Lunenburg")
# ) %>%
#   filter(VARIABLE == "Temperature") %>% 
#   select(-WATERBODY, -LEASE, -VARIABLE, -SENSOR, -DEPLOYMENT_PERIOD, 
#          -UNITS, -MOORING) %>% 
#   filter(
#     STATION == "Flat Island" | 
#       STATION == "Beaver Point" | 
#       STATION == "Madeline Point"
#   ) %>% 
#   convert_depth_to_ordered_factor() %>% 
#   mutate(
#     STATION = ordered(
#       STATION, levels = c("Madeline Point", "Beaver Point", "Flat Island")
#     )
#   )
# 
# colour_pal <- get_colour_palette(dat_raw)

```


# Motivation

- Recent trend in Atlantic salmon aquaculture to stock large post-smolts (~ 1 kg) 
--

- Mainly to reduce disease potential 
--

- Could also enable grow-out to market size in less than a year
--

.pull-center[
**Potential for novel sites in areas typically considered unsuitable for aquaculture**
]

???
- I'll start with discussing the motivation for the paper, and then talk about the model we used before jumping into the results.

- As you know, cultured salmon are grown on land in fresh water for the first part of their life, and then transferred to salt water farms when they become smolt.

- Typically this happens when the smolt are about 100 to 150 g

- There has been a recent trend in the industry to stock psot-smolts that are closer to 500 g or even a full 1 kg.

- This strategy has primarily been implemented to reduce disease potential, and has also been used to reduce grow-out time.

- Depending on local temperature and initial fish size, large post-smolt stocking could enable grow-out to target market weights in less than a year

- Which could open up novel sites in areas that are typically considered unsuitable for aquaculture because they experience seasonal superchill.


- Smolts are produced in freshwater land-based hatcheries 
- Smoltification is when salmon change lifestages from being “parr” in freshwater to “smolts” adapted to saltwater.
- This is now commonly done when the salmon reach about 100 to 150g after 8-10 months.

Norway:
Prior to January 2013, the maximum allowable juvenile weight was 250 g. In January 2013, this value was changed to 1 kg, increasing the flexibility of the production process. 

- Larger smolts are increasingly popular in Norway, where licences for extra biomass are limited and expensive, in Tasmania, and to an increasing extent in Scotland.

---
# Thermal Growth Coefficient Model

Relates initial weight and final weight based on the average temperature over a period of time

$$
w_0 = (w_t^{1/3} - \frac{TGC}{1000} * degreedays)^3
$$

$$degreedays = T_{Avg} * n_{days}$$
--


- $w_0$ = initial stocking weight (kg)
- $w_t$ = final weight after grow-out (kg)
- $TGC$ = thermal growth coefficient (remedial = 0.25, average = 0.30, elite = 0.35)
- $degreedays$ = degree days experienced by fish over growing season
- $T_{Avg}$ = average temperature over the growing season*
- $n_{days}$ = number of days in the growing season*

*Assume no growth for 24 hours after observation $\ge$ 18 degrees Celsius 

---
# Thermal Growth Coefficient Model

How big does a post-smolt salmon need to be to grow out to market size at a given location?

$$
w_0 = (w_t^{1/3} - \frac{TGC}{1000} * degreedays)^3
$$


$$degreedays = T_{Avg} * n_{days}$$
--

- $w_0$ = initial stocking weight (kg)
- $w_t$ = final weight after grow-out (kg)
- $TGC$ = thermal growth coefficient (remedial = 0.25, average = 0.30, elite = 0.35)
- $degreedays$ = degree days experienced by fish over growing season
- $T_{Avg}$ = average temperature over the growing season*
- $n_{days}$ = number of days in the growing season*



*Assume no growth for 24 hours after observation $\ge$ 18 degrees Celsius 

???

ALT text: How big does a post-smolt salmon need to be to grow out to market size at a given location?


- To explore this potential, we are using the thermal growth coefficient model

- Common model that relates final weight and initial weight of a fish based on the average temperature it experiences over a given period of time

(observations in this window are removed and not included in $T_{Avg}$ or $n_{days}$)

---
# Coastal Monitoring Program

- High resolution monitoring of **temperature** (plus dissolved oxygen & some salinity)
- Processed 190 deployments from 86 locations

```{r, echo=FALSE, fig.height=5.6}

all_stations <- read_csv(
  here("data/Station_Locations_2021-12-21.csv"), show_col_types = FALSE)

p <- all_stations %>% 
  mutate(
    COUNTY = paste("County:", COUNTY),
    WATERBODY = paste("Waterbody:", WATERBODY),
    STATION = paste("Station:", STATION),
    LABEL = paste(COUNTY, WATERBODY, STATION, sep = "</br>")
  ) %>% 
  leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron)%>%
  addMarkers(~LONGITUDE, ~LATITUDE, popup = ~LABEL)

p


```

???
notes to self here

`r knitr::knit_exit()`

---

## Station Map

```{r, echo=FALSE}

dat_map <- dat_raw %>% 
  distinct(STATION, .keep_all = TRUE) 

dat_map %>% 
  leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron)%>%
  addMarkers(~LONGITUDE, ~LATITUDE, label = ~STATION)

```


```{r, echo=FALSE, eval=FALSE}

dat_map <- dat_map %>% 
  mutate(
    SEASON = case_when(
      STATION == "Flat Island" ~ "Long Season",
      STATION == "Beaver Point" ~ "Medium Season",
      STATION == "Madeline Point" ~ "Short Season"
    ),
    LABEL = glue("{STATION} \n ({SEASON})")) %>% 
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326, agr = "constant") 

map_box <- data.frame(Long = c(-66, -59.9), Lat = c(43.5, 47)) %>%
  st_as_sf(coords = c("Long", "Lat"), crs = 4326)

ggplot() +
  geom_sf(data = map_box) +
  annotation_map_tile(type = "cartolight", zoomin = -1) +
  geom_sf(data = dat_map) +
  geom_sf_label(
    data = dat_map, aes(label = LABEL),
    label.size = NA, fill = NA, nudge_y = -0.25, size = 2.7
  ) +
  scale_x_continuous(breaks = c(seq(-60, -66, -2))) +
  scale_y_continuous(breaks = c(seq(44, 47, 1))) +
  annotation_scale(location = "br") +
  annotation_north_arrow(
    location = "tl", which_north = "true",
    height = unit(1, "cm"),
    width = unit(1, "cm")
  ) +
  theme(axis.title = element_blank(),
        text = element_text(size = 10))

ggsave(
  filename = "figure1.png",
  path = here("figs"),
  device = "png",
  width = 11.2, height = 8, units = "cm",
  dpi = 600
)

```




```{r, message=FALSE, warning=FALSE}

# ANALYSIS HERE

# CAN send this to count_degree_days() (but NOT if heat stress events are filtered)
dat_seasons <-  dat_raw %>% 
  filter_in_growing_seasons() %>% 
  filter(
    (STATION == "Flat Island" & SEASON == "S3") |
      (STATION == "Beaver Point" & SEASON == "S2") |
      (STATION == "Madeline Point" & SEASON == "S2")
  ) 

# check for data gaps 
gap_table <- dat_seasons %>% 
  check_for_data_gaps(STATION) %>% 
  arrange(STATION, DEPTH) %>% 
  group_by(STATION, DEPTH) %>%
  summarize(TOTAL_GAP_DAYS = sum(GAP_LENGTH_DAYS)) %>%
  ungroup()

# degree days
dd <- count_degree_days(dat_seasons, STATION, rm_gap_days = FALSE) %>% 
  select(-SEASON, -n_OBSERVATIONS) %>% 
  relocate(AVG_TEMPERATURE, .before = n_degree_days)

# TGC model
w_t <- 5.5
tgc <- c(0.25, 0.3, 0.35)

tgc_table <- TGC_calculate_initial_weight(dd, final_weight = w_t, tgc = tgc) %>%
  arrange(STATION, DEPTH) %>% 
  select(-FINAL_WEIGHT)

# Full TGC pipeline
# tgc_table <- dat_raw %>% 
#   filter_in_growing_seasons() %>% 
#   filter(
#     (STATION == "Flat Island" & SEASON == "S3") |
#       (STATION == "Beaver Point" & SEASON == "S2") |
#       (STATION == "Madeline Point" & SEASON == "S2")
#   ) %>% 
#   count_degree_days(STATION) %>% 
#   TGC_calculate_initial_weight(final_weight = w_t, tgc = tgc) %>% 
#   arrange(STATION, DEPTH)

# filter out heat stress events for plotting (do NOT send this to count_dd)
dat_filt <- dat_seasons %>% 
  filter_out_heat_stress_events() 

```


```{r, echo=FALSE}
n_days <- 14
text_size <- 8
plot_theme <- theme(axis.text = element_text(size = text_size))

```


## Growing Seasons {.tabset}

### Madeline Point (Short Season)

```{r, echo=FALSE, message=FALSE}

short_filt <- dat_filt %>%
  filter(STATION == "Madeline Point")

min_timestamp <- min(short_filt$TIMESTAMP) - days(n_days)
max_timestamp <- max(short_filt$TIMESTAMP) + days(n_days)

short_raw <- dat_raw %>% 
  filter(STATION == "Madeline Point",
         TIMESTAMP >= min_timestamp, TIMESTAMP <= max_timestamp)

p2 <- plot_filtered_data(short_raw, short_filt,
                         date_breaks_major = "1 month",
                         date_labels_format = "%Y-%b", 
                         plotly_friendly = FALSE) +
  plot_theme
  
p2

```


### Beaver Point (Medium Season)

```{r, echo=FALSE, message=FALSE}

med_filt <- dat_filt %>%
  filter(STATION == "Beaver Point")

min_timestamp <- min(med_filt$TIMESTAMP) - days(n_days)
max_timestamp <- max(med_filt$TIMESTAMP) + days(n_days)

med_raw <- med_raw %>% 
  filter(STATION == "Beaver Point",
         TIMESTAMP >= min_timestamp, TIMESTAMP <= max_timestamp)

p2 <- plot_filtered_data(med_raw, med_filt,
                         date_breaks_major = "1 month",
                         date_labels_format = "%Y-%b", 
                         plotly_friendly = FALSE) +
  plot_theme
  
p2

```


```{r, eval=FALSE}

fig_width <- 19
fig_height <- 7

ggsave(
  p2,
  filename = "figure2.png",
  path = here("figs"),
  device = "png",
  width = fig_width, height = fig_height, units = "cm",
  dpi = 600
)

```


## Degree Days {.tabset}

### Figure 
```{r}

p <- ggplot(dd, aes(STATION, n_degree_days, fill = DEPTH,
                    text = paste(
                      "Depth: ", DEPTH, "m", "\n",
                      "Average Temp: ", AVG_TEMPERATURE, "\n",
                      "Growing Days: ", n_growing_days, "\n",
                      "Degree Days: ", n_degree_days))
) +
  geom_point(pch = 21, size = 4,
             position = position_jitter(width = 0.05, height = 0, seed = 10)) +
  scale_fill_manual("Depth (m)", values = colour_pal) +
  scale_x_discrete(name = "") +
  scale_y_continuous(name = "Number of Degree Days") +
  theme_light()

ggplotly(p, tooltip = "text") %>%
  config(
    modeBarButtonsToRemove = list(
      "toggleSpikelines", "autoScale2d", "select2d", "lasso2d",
      "hoverCompareCartesian", "zoom2d"
    ),
    displaylogo = FALSE,
    toImageButtonOptions = list(
      format = "png",
      filename = "degree_days",
      width = 1100,
      height = 1100
    )) %>%
  layout(
    margin = list(b = 90, l = 90) # to fully display the x and y axis labels
  )

```

### Table
```{r echo=FALSE}

dd %>%
  mutate(
    START_SEASON = format(as_date(START_SEASON)),
    END_SEASON = format(as_date(END_SEASON))
  ) %>% 
  arrange(STATION) %>% 
  datatable(
    rownames = FALSE, options = dt_options, 
    caption = "Figure 1: Degree days after applying season and heat stress filters."
  )

```
Note: Partial STOCKED_DAYS caused by the times of END_SEASON and START_SEASON (not shown).

## Thermal Growth Coefficient Model {.tabset}


### Figure
```{r}

p <-  ggplot(tgc_table, aes(x = factor(TGC), y = TGC_INITIAL_WEIGHT, fill = DEPTH,
             text = paste(
                      "Depth: ", DEPTH, "m", "\n",
                      "Average Temp: ", AVG_TEMPERATURE, "\n",
                      "Growing Days: ", n_growing_days, "\n",
                      "Degree Days: ", n_degree_days, "\n",
                      "Initial Weight: ", TGC_INITIAL_WEIGHT ))) +
  geom_point(
    pch = 21, size = 3, alpha = 0.75,
    position = position_jitter(width = 0.15, height = 0, seed = 10)
  ) +
  scale_fill_manual("Depth (m)", values = colour_pal, drop = FALSE) +
  scale_x_discrete("TGC Value") +
  scale_y_continuous("Initial Weight (kg)") +
  facet_wrap(~STATION)


ggplotly(p, tooltip = "text") %>%
  config(
    modeBarButtonsToRemove = list(
      "toggleSpikelines", "autoScale2d", "select2d", "lasso2d",
      "hoverCompareCartesian", "zoom2d"
    ),
    displaylogo = FALSE,
    toImageButtonOptions = list(
      format = "png",
      filename = "degree_days",
      width = 1100,
      height = 1100
    )) %>%
  layout(
    margin = list(b = 90, l = 90) # to fully display the x and y axis labels
  )

```


### Table

```{r}

tgc_table %>%
  select(-START_SEASON, -END_SEASON) %>%
  arrange(STATION, DEPTH) %>%
  datatable(rownames = FALSE, options = dt_options)

```











